<?xml version="1.0" encoding="UTF-8"?>
<sequence name="main_equity_ers_seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <propertyGroup>
        <property expression="$body/mediate/bucket" name="bucket" scope="default" type="STRING"/>
        <property expression="$body/mediate/osDir" name="osDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/topic" name="topic" scope="default" type="STRING"/>
        <property expression="$body/mediate/localDir" name="localDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/filePattern" name="filePattern" scope="default" type="STRING"/>
        <property expression="$body/mediate/archivedDir" name="archivedDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/archiveAction" name="archiveAction" scope="default" type="STRING"/>
        <property expression="$body/mediate/requestId" name="requestId" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Reading files..."/>
        <property expression="$ctx:localDir" name="Local Dir"/>
        <property expression="$ctx:filePattern" name="File Pattern"/>
    </log>
    <file.listFiles configKey="LOCAL_FILE_DIR">
        <directoryPath>{$ctx:localDir}</directoryPath>
        <matchingPattern>{$ctx:filePattern}</matchingPattern>
        <recursive>true</recursive>
        <responseFormat>Flat</responseFormat>
        <sortingAttribute>Name</sortingAttribute>
        <sortingOrder>Ascending</sortingOrder>
    </file.listFiles>
    <log category="DEBUG" level="full"/>
    <filter xpath="count(//listFilesResult/files/file) &lt;= 0">
        <then>
            <log>
                <property name="Message" value="No file found"/>
            </log>
            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
            <payloadFactory media-type="json">
                <format>{"requestId": "$1", "status": "no_message_sent", "message": "No matched file found in $2"}</format>
                <args>
                    <arg evaluator="xml" expression="$ctx:requestId"/>
                    <arg evaluator="xml" expression="$ctx:localDir"/>
                </args>
            </payloadFactory>
            <respond/>
        </then>
        <else>
            <property expression="count(//listFilesResult/files/file)" name="numOfFile" scope="default" type="STRING"/>
            <log>
                <property expression="fn:concat('Found ',$ctx:numOfFile,' file(s)')" name="Message"/>
            </log>
        </else>
    </filter>
    <foreach expression="//listFilesResult/files/file">
        <sequence>
            <propertyGroup>
                <property expression="//file/path/text()" name="filePath" scope="default" type="STRING"/>
                <property expression="//file/name/text()" name="filename" scope="default" type="STRING"/>
            </propertyGroup>
            <script language="js"><![CDATA[var filePath = mc.getProperty('filePath')
var localDir = mc.getProperty('localDir')
var filename = mc.getProperty('filename')
var idx = filePath.indexOf(localDir)
var subPath = filePath.substring(idx + localDir.length() + 1)
java.lang.System.out.println("Relative path: " + subPath)
mc.setProperty('fileSubPath', subPath)

var match = filename.match(/([A-Z0-9]+)(.pdf.txt)/);
mc.setProperty('filenameWithoutExt', match[1]);]]></script>
            <log>
                <property name="Message" value="Reading file from local storage"/>
                <property expression="$ctx:localDir" name="Local Dir"/>
                <property expression="$ctx:filePath" name="File"/>
                <property expression="$ctx:fileSubPath" name="SubPath"/>
            </log>
            <file.read configKey="LOCAL_FILE_DIR">
                <path>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</path>
                <readMode>Complete File</readMode>
                <startLineNum>0</startLineNum>
                <lineNum>0</lineNum>
                <contentType>text/plain</contentType>
                <includeResultTo>Message Body</includeResultTo>
                <enableStreaming>false</enableStreaming>
                <enableLock>false</enableLock>
            </file.read>
            <propertyGroup>
                <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
            </propertyGroup>
            <log>
                <property name="Message" value="Build kafka message"/>
                <property expression="$ctx:filenameWithoutExt" name="Email ID"/>
            </log>
            <payloadFactory media-type="json">
                <format>{"email":"$1","emailId":"$2"}</format>
                <args>
                    <arg evaluator="xml" expression="$body//text()"/>
                    <arg evaluator="xml" expression="$ctx:filenameWithoutExt"/>
                </args>
            </payloadFactory>
            <sequence key="Publish_Message_To_Kafka"/>
            <log>
                <property name="Message" value="Upload completed"/>
                <property expression="get-property('putObjectResult')" name="PutObjectResult"/>
                <property expression="$ctx:filename" name="Filename"/>
            </log>
            <switch source="$ctx:archiveAction">
                <case regex="MOVE">
                    <log>
                        <property name="Message" value="ARCHIVING: Moving file to archive directory"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                    <file.move configKey="LOCAL_FILE_DIR">
                        <sourcePath>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</sourcePath>
                        <targetPath>{$ctx:archivedDir}</targetPath>
                        <createParentDirectories>true</createParentDirectories>
                        <includeParent>false</includeParent>
                        <overwrite>true</overwrite>
                    </file.move>
                    <log>
                        <property name="Message" value="Archived completed"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                        <property expression="//moveFilesResult/success/text()" name="Archive Result"/>
                    </log>
                </case>
                <case regex="DELETE">
                    <log>
                        <property name="Message" value="ARCHIVING: Delete file"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                    <file.delete configKey="LOCAL_FILE_DIR">
                        <path>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</path>
                    </file.delete>
                    <log>
                        <property name="Message" value="Archived completed"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                        <property expression="//deleteFileResult/success/text()" name="Archive Result"/>
                    </log>
                </case>
                <default>
                    <log>
                        <property name="Message" value="ARCHIVING: Do nothing"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                </default>
            </switch>
            <log>
                <property name="Message" value="Process file completed"/>
                <property expression="$ctx:filename" name="Filename"/>
            </log>
        </sequence>
    </foreach>
    <respond/>
</sequence>
