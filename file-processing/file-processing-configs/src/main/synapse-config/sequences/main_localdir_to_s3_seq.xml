<?xml version="1.0" encoding="UTF-8"?>
<sequence name="main_localdir_to_s3_seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <propertyGroup>
        <property expression="$body/mediate/bucket" name="bucket" scope="default" type="STRING"/>
        <property expression="$body/mediate/osDir" name="osDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/topic" name="topic" scope="default" type="STRING"/>
        <property expression="$body/mediate/localDir" name="localDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/filePattern" name="filePattern" scope="default" type="STRING"/>
        <property expression="$body/mediate/archivedDir" name="archivedDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/archiveAction" name="archiveAction" scope="default" type="STRING"/>
        <property expression="$body/mediate/requestId" name="requestId" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Reading files..."/>
        <property expression="$ctx:localDir" name="Local Dir"/>
        <property expression="$ctx:filePattern" name="File Pattern"/>
    </log>
    <file.listFiles configKey="LOCAL_FILE_DIR">
        <directoryPath>{$ctx:localDir}</directoryPath>
        <matchingPattern>{$ctx:filePattern}</matchingPattern>
        <recursive>true</recursive>
        <responseFormat>Flat</responseFormat>
        <sortingAttribute>Name</sortingAttribute>
        <sortingOrder>Ascending</sortingOrder>
    </file.listFiles>
    <log category="DEBUG" level="full"/>
    <filter xpath="count(//listFilesResult/files/file) &lt;= 0">
        <then>
            <log>
                <property name="Message" value="No file found"/>
            </log>
            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
            <payloadFactory media-type="json">
                <format>{"requestId": "$1", "status": "no_message_sent", "message": "No matched file found in $2"}</format>
                <args>
                    <arg evaluator="xml" expression="$ctx:requestId"/>
                    <arg evaluator="xml" expression="$ctx:localDir"/>
                </args>
            </payloadFactory>
            <respond/>
        </then>
        <else>
            <property expression="count(//listFilesResult/files/file)" name="numOfFile" scope="default" type="STRING"/>
            <log>
                <property expression="fn:concat('Found ',$ctx:numOfFile,' file(s)')" name="Message"/>
            </log>
        </else>
    </filter>
    <foreach expression="//listFilesResult/files/file">
        <sequence>
            <propertyGroup>
                <property expression="//file/path/text()" name="filePath" scope="default" type="STRING"/>
                <property expression="//file/name/text()" name="filename" scope="default" type="STRING"/>
            </propertyGroup>
            <script language="js"><![CDATA[var filePath = mc.getProperty('filePath')
var localDir = mc.getProperty('localDir')
var idx = filePath.indexOf(localDir)
var subPath = filePath.substring(idx + localDir.length() + 1)
java.lang.System.out.println("Relative path: " + subPath)
mc.setProperty('fileSubPath', subPath)]]></script>
            <log>
                <property name="Message" value="Reading file from local storage"/>
                <property expression="$ctx:localDir" name="Local Dir"/>
                <property expression="$ctx:filePath" name="File"/>
                <property expression="$ctx:fileSubPath" name="SubPath"/>
            </log>
            <file.read configKey="LOCAL_FILE_DIR">
                <path>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</path>
                <readMode>Complete File</readMode>
                <startLineNum>0</startLineNum>
                <lineNum>0</lineNum>
                <contentType>application/binary</contentType>
                <includeResultTo>Message Body</includeResultTo>
                <enableStreaming>false</enableStreaming>
                <enableLock>false</enableLock>
            </file.read>
            <propertyGroup>
                <property expression="fn:concat($ctx:osDir,'/',$ctx:fileSubPath)" name="objectKey" scope="default" type="STRING"/>
            </propertyGroup>
            <minio.putObject>
                <address>{get-property('FILE_SERVICE_ENDPOINT')}</address>
                <bucket>{$ctx:bucket}</bucket>
                <objectKey>{$ctx:objectKey}</objectKey>
                <accessKey>minioadmin</accessKey>
                <secretKey>minioadmin</secretKey>
            </minio.putObject>
            <script language="js"><![CDATA[var filename =mc.getProperty('filename');

java.lang.System.out.println('Extract file extension from  filename: '+ filename); 
var ext = filename.substring(filename.lastIndexOf('.')+1)
mc.setProperty('fileFormat', ext);]]></script>
            <log>
                <property name="Message" value="Upload completed"/>
                <property expression="get-property('putObjectResult')" name="PutObjectResult"/>
                <property expression="$ctx:filename" name="Filename"/>
            </log>
            <switch source="$ctx:archiveAction">
                <case regex="MOVE">
                    <log>
                        <property name="Message" value="ARCHIVING: Moving file to archive directory"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                    <file.move configKey="LOCAL_FILE_DIR">
                        <sourcePath>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</sourcePath>
                        <targetPath>{$ctx:archivedDir}</targetPath>
                        <createParentDirectories>true</createParentDirectories>
                        <includeParent>false</includeParent>
                        <overwrite>true</overwrite>
                    </file.move>
                    <log>
                        <property name="Message" value="Archived completed"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                        <property expression="//moveFilesResult/success/text()" name="Archive Result"/>
                    </log>
                </case>
                <case regex="DELETE">
                    <log>
                        <property name="Message" value="ARCHIVING: Delete file"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                    <file.delete configKey="LOCAL_FILE_DIR">
                        <path>{fn:concat($ctx:localDir,'/',$ctx:fileSubPath)}</path>
                    </file.delete>
                    <log>
                        <property name="Message" value="Archived completed"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                        <property expression="//deleteFileResult/success/text()" name="Archive Result"/>
                    </log>
                </case>
                <default>
                    <log>
                        <property name="Message" value="ARCHIVING: Do nothing"/>
                        <property expression="$ctx:fileSubPath" name="File"/>
                    </log>
                </default>
            </switch>
            <payloadFactory media-type="xml">
                <format>
                    <file xmlns="">
                        <filename>$1</filename>
                        <fileUrl>$2</fileUrl>
                        <fileFormat>$3</fileFormat>
                    </file>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:filename"/>
                    <arg evaluator="xml" expression="$ctx:objectKey"/>
                    <arg evaluator="xml" expression="$ctx:fileFormat"/>
                </args>
            </payloadFactory>
            <log>
                <property name="Message" value="Process file completed"/>
                <property expression="$ctx:filename" name="Filename"/>
            </log>
        </sequence>
    </foreach>
    <log category="DEBUG" level="full">
        <property name="Message" value="Prepare message to kafka"/>
    </log>
    <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
    <jsontransform schema="files"/>
    <payloadFactory media-type="json">
        <format>{"requestId": "$1", "files": $2}</format>
        <args>
            <arg evaluator="xml" expression="$ctx:requestId"/>
            <arg evaluator="json" expression="$.listFilesResult.files.file"/>
        </args>
    </payloadFactory>
    <property expression="json-eval($.)" name="kafkaMessage" scope="default" type="STRING"/>
    <log category="DEBUG" level="full">
        <property name="Message" value="Calling to send to kafka"/>
    </log>
    <sequence key="Publish_Message_To_Kafka"/>
    <propertyGroup>
        <property name="ContentType" scope="axis2" type="STRING" value="application/json"/>
    </propertyGroup>
    <payloadFactory media-type="json">
        <format>{ "requestId": "$1", "status": "$2", "kafkaMessage": $3}</format>
        <args>
            <arg evaluator="xml" expression="$ctx:requestId"/>
            <arg evaluator="json" expression="$.text"/>
            <arg evaluator="xml" expression="$ctx:kafkaMessage"/>
        </args>
    </payloadFactory>
    <log>
        <property name="Message" value="Publish message to kafka successfully"/>
    </log>
    <respond/>
</sequence>
