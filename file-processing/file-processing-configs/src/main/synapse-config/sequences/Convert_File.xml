<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Convert_File" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Start convert file"/>
        <property expression="$ctx:fileUrl" name="File Url"/>
        <property expression="$ctx:traceId" name="Trace Id"/>
        <property expression="$ctx:toFileFormat" name="To Format"/>
    </log>
    <propertyGroup>
        <property expression="fn:concat(get-property('file','API_GATEWAY'),'/convert/convert')" name="uri.var.imageConversionUrl" scope="default" type="STRING"/>
        <property expression="fn:substring($ctx:fileUrl, fn:string-length($ctx:bucket))" name="filePath" scope="default" type="STRING"/>
    </propertyGroup>
    <script language="js"><![CDATA[var fileUrl = mc.getProperty('fileUrl')
var filename = fileUrl.substring(fileUrl.lastIndexOf('/')+1)
var fileFormat = filename.substring(filename.lastIndexOf('.')+1)
mc.setProperty('filename',filename)
mc.setProperty('fileFormat',fileFormat)
mc.setProperty('shortFilename',filename.substring(0,filename.lastIndexOf('.')))]]></script>
    <log>
        <property expression="$ctx:filename" name="Filename"/>
        <property expression="$ctx:filePath" name="File Path"/>
        <property expression="$ctx:fileFormat" name="File Format"/>
    </log>
    <payloadFactory media-type="json">
        <format>{&#xd;
    "traceId": "$1",&#xd;
    "eventId": "$2",&#xd;
    "files": [&#xd;
        {&#xd;
            "fileId": "1",&#xd;
            "fileName": "$3",&#xd;
            "fileFormat": "$4",&#xd;
            "fileUrl": "$5",&#xd;
            "metadata": {&#xd;
                "fileSize": 400000&#xd;
            }&#xd;
        }&#xd;
    ],&#xd;
    "managementData": {&#xd;
        "status": "GENERATE_THUMBNAIL_IMAGE_READY",&#xd;
        "stepsMetadata": []&#xd;
    },&#xd;
    "processingData": [],&#xd;
    "config": {&#xd;
        "toFileFormat": "$6",&#xd;
        "extensions": "png,jpg,jpeg"&#xd;
    }&#xd;
}</format>
        <args>
            <arg evaluator="xml" expression="$ctx:traceId"/>
            <arg evaluator="xml" expression="$ctx:eventId"/>
            <arg evaluator="xml" expression="$ctx:filename"/>
            <arg evaluator="xml" expression="$ctx:fileFormat"/>
            <arg evaluator="xml" expression="$ctx:fileUrl"/>
            <arg evaluator="xml" expression="$ctx:toFileFormat"/>
        </args>
    </payloadFactory>
    <call>
        <endpoint>
            <http method="post" uri-template="{uri.var.imageConversionUrl}">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>-1</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                </markForSuspension>
            </http>
        </endpoint>
    </call>
    <propertyGroup>
        <property name="transport.vfs.ContentType" scope="default" type="STRING" value="application/json"/>
        <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
    </propertyGroup>
    <payloadFactory media-type="json">
        <format>$1</format>
        <args>
            <arg evaluator="json" expression="$.processingData[0]"/>
        </args>
    </payloadFactory>
    <log level="full">
        <property name="Message" value="Convert file completed"/>
    </log>
</sequence>
