<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Azure_OpenAI" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <propertyGroup>
        <property expression="fn:concat(get-property('file','API_GATEWAY'),'/openai')" name="uri.var.openAIUrl" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Extract data fields from text with OpenAI"/>
    </log>
    <header action="remove" name="Content-Encoding" scope="transport"/>
    <payloadFactory media-type="json">
        <format>{&#xd;
    "messages": [&#xd;
        {&#xd;
            "role": "user",&#xd;
            "content": "$1 $2"&#xd;
        }&#xd;
    ],&#xd;
    "temperature": 0.7,&#xd;
    "top_p":0.95,&#xd;
    "max_tokens":2000&#xd;
}</format>
        <args>
            <arg value="Extract customer customer number from below text:"/>
            <arg evaluator="xml" expression="$ctx:rawText"/>
        </args>
    </payloadFactory>
    <call>
        <endpoint>
            <http method="post" uri-template="{uri.var.openAIUrl}">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>-1</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                </markForSuspension>
            </http>
        </endpoint>
    </call>
    <propertyGroup>
        <property name="transport.vfs.ContentType" scope="default" type="STRING" value="application/json"/>
        <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
    </propertyGroup>
    <log level="full">
        <property name="Message" value="Extract data fields from OpenAI completed"/>
    </log>
</sequence>
