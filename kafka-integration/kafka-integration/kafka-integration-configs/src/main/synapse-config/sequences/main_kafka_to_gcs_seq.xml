<?xml version="1.0" encoding="UTF-8"?>
<sequence name="main_kafka_to_gcs_seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Receive cache event"/>
        <property expression="get-property('partitionNo')" name="Partition"/>
        <property expression="get-property('offset')" name="Offset"/>
        <property expression="get-property('eventId')" name="Event Id"/>
        <property expression="get-property('action')" name="Event Action"/>
        <property expression="get-property('type')" name="Event Type"/>
        <property expression="get-property('topic')" name="Topic"/>
    </log>
    <switch source="get-property('action')">
        <case regex="EXPIRED"/>
        <default>
            <log>
                <property name="Message" value="Save event to GCS"/>
                <property expression="$ctx:eventId" name="Event Id"/>
            </log>
            <gcs.putObject>
                <projectId>splendid-sonar-174914</projectId>
                <bucket>ps_data</bucket>
                <objectKey>{fn:concat(get-property('topic'),'/',get-property('type'),'/',get-property('eventId'),'.json')}</objectKey>
                <content>{json-eval($.)}</content>
            </gcs.putObject>
        </default>
    </switch>
</sequence>
