<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Local_File_To_SFTP" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Upload file to SFTP"/>
    </log>
    <propertyGroup>
        <property expression="$body/mediate/dir" name="scanningDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/filePattern" name="filePattern" scope="default" type="STRING"/>
        <property expression="$body/mediate/archivedDir" name="archivedDir" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Reading files..."/>
        <property expression="$ctx:scanningDir" name="Scanning Dir"/>
        <property expression="$ctx:filePattern" name="File Pattern"/>
    </log>
    <file.listFiles configKey="LOCAL_FILE_DIR">
        <directoryPath>{$ctx:scanningDir}</directoryPath>
        <matchingPattern>{$ctx:filePattern}</matchingPattern>
        <recursive>false</recursive>
        <responseFormat>Hierarchical</responseFormat>
        <sortingAttribute>Name</sortingAttribute>
        <sortingOrder>Ascending</sortingOrder>
    </file.listFiles>
    <log level="full"/>
    <foreach expression="//listFilesResult/directory/file">
        <sequence>
            <property expression="//file/text()" name="filename" scope="default" type="STRING"/>
            <log>
                <property name="Message" value="Moving file..."/>
                <property expression="$ctx:filename" name="Filename"/>
                <property expression="get-property('FOREACH_COUNTER')" name="Offset"/>
            </log>
            <file.read configKey="LOCAL_FILE_DIR">
                <path>{fn:concat($ctx:scanningDir,'/',$ctx:filename)}</path>
                <readMode>Complete File</readMode>
                <startLineNum>0</startLineNum>
                <lineNum>0</lineNum>
                <contentType>application/binary</contentType>
                <includeResultTo>Message Body</includeResultTo>
                <enableStreaming>false</enableStreaming>
                <enableLock>false</enableLock>
            </file.read>
            <sequence key="Upload_To_SFTP_Seq"/>
            <file.move configKey="LOCAL_FILE_DIR">
                <sourcePath>{fn:concat($ctx:scanningDir,'/',$ctx:filename)}</sourcePath>
                <targetPath>{$ctx:archivedDir}</targetPath>
                <createParentDirectories>true</createParentDirectories>
                <includeParent>false</includeParent>
                <overwrite>true</overwrite>
            </file.move>
            <log>
                <property name="Message" value="Archived completed"/>
                <property expression="$ctx:filename" name="Filename"/>
                <property expression="//moveFilesResult/success/text()" name="Archive Result"/>
            </log>
            <propertyGroup>
                <property name="UPLOAD_SUCCESSFUL" scope="default" type="STRING" value="true"/>
                <property expression="//moveFilesResult/success/text()" name="ARCHIVE_SUCCESSFUL" scope="default" type="STRING"/>
            </propertyGroup>
            <payloadFactory media-type="xml">
                <format>
                    <file xmlns="">
                        <filename>$1</filename>
                        <uploadSuccessful>$2</uploadSuccessful>
                        <archiveSuccessful>$3</archiveSuccessful>
                    </file>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:filename"/>
                    <arg evaluator="xml" expression="$ctx:UPLOAD_SUCCESSFUL"/>
                    <arg evaluator="xml" expression="$ctx:ARCHIVE_SUCCESSFUL"/>
                </args>
            </payloadFactory>
        </sequence>
    </foreach>
    <log level="full">
        <property name="Message" value="Process completed"/>
    </log>
    <respond/>
</sequence>
