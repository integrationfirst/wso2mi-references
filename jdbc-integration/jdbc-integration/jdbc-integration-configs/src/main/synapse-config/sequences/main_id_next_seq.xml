<?xml version="1.0" encoding="UTF-8"?>
<sequence name="main_id_next_seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <propertyGroup>
        <property expression="get-property('uri.var.sequenceId')" name="sequenceId" scope="default" type="STRING"/>
        <property expression="get-property('uri.var.action')" name="sequenceAction" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Generating sequence id..."/>
        <property expression="$ctx:sequenceId" name="Sequence"/>
        <property expression="$ctx:sequenceAction" name="Action"/>
    </log>
    <!-- <dataServiceCall serviceName="id_generation">
        <operations type="single">
            <operation name="addTable"/>
        </operations>
        <source type="inline"/>
        <target name="tableCreationResult" type="property"/>
    </dataServiceCall> -->
    <dataServiceCall serviceName="id_generation">
        <operations type="single">
            <operation name="getSequenceValueById">
                <param evaluator="xml" expression="$ctx:sequenceId" name="sequenceId"/>
            </operation>
        </operations>
        <source type="inline"/>
        <target type="body"/>
    </dataServiceCall>
    <log level="full"/>
    <property expression="json-eval($.Sequences.Sequence.currentValue)" name="currentValue" scope="default" type="INTEGER"/>
    <log>
        <property name="Message" value="Current sequence value"/>
        <property expression="$ctx:currentValue" name="CurrentValue"/>
    </log>
    <filter regex="[0-9]+" source="$ctx:currentValue">
        <then>
            <log>
                <property name="Message" value="Sequence exists"/>
                <property expression="$ctx:currentValue" name="Current Value"/>
            </log>
        </then>
        <else>
            <log>
                <property name="Message" value="The sequence does not exist"/>
                <property expression="$ctx:sequenceId" name="Sequence"/>
            </log>
            <property name="currentValue" scope="default" type="INTEGER" value="0"/>
            <dataServiceCall serviceName="id_generation">
                <operations type="single">
                    <operation name="addSequence">
                        <param evaluator="xml" expression="$ctx:sequenceId" name="sequenceId"/>
                        <param name="sequenceName" value="property_value"/>
                        <param evaluator="xml" expression="$ctx:currentValue" name="currentValue"/>
                    </operation>
                </operations>
                <source type="inline"/>
                <target name="addSequenceResult" type="property"/>
            </dataServiceCall>
        </else>
    </filter>
    <script language="js"><![CDATA[var newV=   parseInt(mc.getProperty('currentValue'))+1
mc.setProperty('newValue', newV + "" )]]></script>
    <property expression="get-property('newValue')" name="newValue" scope="default" type="INTEGER"/>
    <dataServiceCall serviceName="id_generation">
        <operations type="single">
            <operation name="saveSequence">
                <param evaluator="xml" expression="$ctx:sequenceId" name="sequenceId"/>
                <param evaluator="xml" expression="get-property('newValue')" name="currentValue"/>
            </operation>
        </operations>
        <source type="inline"/>
        <target type="body"/>
    </dataServiceCall>
    <payloadFactory media-type="text">
        <format>$1</format>
        <args>
            <arg evaluator="xml" expression="$ctx:newValue"/>
        </args>
    </payloadFactory>
    <log level="full"/>
    <respond/>
</sequence>
