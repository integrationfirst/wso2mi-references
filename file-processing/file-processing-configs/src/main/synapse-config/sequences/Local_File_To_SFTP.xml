<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Local_File_To_SFTP" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Upload file to SFTP"/>
    </log>
    <propertyGroup>
        <property expression="$body/mediate/dir" name="scanningDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/filePattern" name="filePattern" scope="default" type="STRING"/>
        <property expression="$body/mediate/archivedDir" name="archivedDir" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Reading files..."/>
        <property expression="$ctx:scanningDir" name="Scanning Dir"/>
        <property expression="$ctx:filePattern" name="File Pattern"/>
    </log>
    <file.read configKey="LOCAL_FILE_DIR">
        <path>{$ctx:scanningDir}</path>
        <filePattern>{$ctx:filePattern}</filePattern>
        <readMode>Complete File</readMode>
        <startLineNum>0</startLineNum>
        <lineNum>0</lineNum>
        <contentType>application/binary</contentType>
        <includeResultTo>Message Body</includeResultTo>
        <enableStreaming>false</enableStreaming>
        <enableLock>false</enableLock>
    </file.read>
    <log>
        <property name="Message" value="Read file complete"/>
        <property expression="$ctx:FILE_NAME" name="Filename"/>
        <property expression="$ctx:FILE_LAST_MODIFIED_TIME" name="Last Modified"/>
        <property expression="$ctx:FILE_SIZE" name="Size"/>
        <property expression="$ctx:FILE_IS_DIR" name="Is Dir"/>
        <property expression="$ctx:FILE_PATH" name="Path"/>
        <property expression="$ctx:FILE_URL" name="Url"/>
        <property expression="$ctx:FILE_NAME_WITHOUT_EXTENSION" name="Name Without Ext"/>
    </log>
    <file.move configKey="LOCAL_FILE_DIR">
        <sourcePath>{get-property('FILE_PATH')}</sourcePath>
        <targetPath>{$ctx:archivedDir}</targetPath>
        <createParentDirectories>true</createParentDirectories>
        <includeParent>false</includeParent>
        <overwrite>false</overwrite>
    </file.move>
    <log>
        <property name="Message" value="Upload completed"/>
        <property expression="get-property('FILE_NAME')" name="Filename"/>
    </log>
</sequence>
