<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Download_File_To_SFTP" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <header expression="$body/mediate/Cookie" name="Cookie" scope="transport"/>
    <propertyGroup>
        <property name="NO_ENTITY_BODY" scope="axis2" type="BOOLEAN" value="false"/>
        <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
        <property expression="$ctx:uri.var.docId" name="fileId" scope="default" type="STRING"/>
    </propertyGroup>
    <payloadFactory media-type="json">
        <format>{}</format>
        <args/>
    </payloadFactory>
    <log level="full">
        <property name="Message" value="Loading the file from remote server"/>
        <property expression="$ctx:fileId" name="FileId"/>
    </log>
    <call>
        <endpoint>
            <http method="get" uri-template="https://docflow.spsbe.com/NextItem/viewpdf?docid={uri.var.docId}">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>-1</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                </markForSuspension>
            </http>
        </endpoint>
    </call>
    <log>
        <property name="Message" value="Download completed"/>
    </log>
    <propertyGroup>
        <property expression="fn:substring($trp:Content-Disposition,18)" name="filename" scope="default" type="STRING"/>
    </propertyGroup>
    <payloadFactory media-type="json">
        <format>{&#xd;
"filename": "$1",&#xd;
"fileId": $2&#xd;
}</format>
        <args>
            <arg evaluator="xml" expression="$ctx:filename"/>
            <arg evaluator="xml" expression="$ctx:fileId"/>
        </args>
    </payloadFactory>
    <respond/>
</sequence>
