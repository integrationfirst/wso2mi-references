<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Upload_To_SFTP_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Prepare to upload file to SFTP server"/>
        <property expression="$ctx:filename" name="Filename"/>
        <property expression="$ctx:sftpDir" name="Directory"/>
    </log>
    <!-- <payloadFactory media-type="xml">
        <format>
            <ns:binary xmlns:ns="http://ws.apache.org/commons/ns/payload">$1</ns:binary>
        </format>
        <args>
            <arg evaluator="xml" expression="$body/attachments/content"/>
        </args>
    </payloadFactory> -->
    <script language="js"><![CDATA[var binaryNode =       
      mc.getEnvelope().getBody().getFirstElement().getFirstOMChild();  
   binaryNode.setBinary(true);]]></script>
    <propertyGroup>
        <property name="OUT_ONLY" scope="default" type="STRING" value="true"/>
        <property name="messageType" scope="axis2" type="STRING" value="application/octet-stream"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Uploading file to SFTP server"/>
        <property expression="$ctx:filename" name="Filename"/>
    </log>
    <file.write configKey="SFTP_SERVER">
        <filePath>{fn:concat($ctx:sftpDir,'/',$ctx:filename)}</filePath>
        <mimeType>application/binary</mimeType>
        <compress>false</compress>
        <writeMode>Overwrite</writeMode>
        <enableStreaming>false</enableStreaming>
        <appendNewLine>false</appendNewLine>
        <enableLock>false</enableLock>
        <includeResultTo>Message Body</includeResultTo>
        <updateLastModified>true</updateLastModified>
    </file.write>
    <!-- <call description="This writes the received file into a pre-configured directory">
        <endpoint>
            <address uri="$FILE:fileProcessing_tempDir">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>1</progressionFactor>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                </markForSuspension>
            </address>
        </endpoint>
    </call> -->
    <!-- 7. We define a success message to be the respose of the REST API request. -->
    <log>
        <property name="Message" value="Upload completed"/>
        <property expression="$ctx:filename" name="Filename"/>
    </log>
</sequence>
