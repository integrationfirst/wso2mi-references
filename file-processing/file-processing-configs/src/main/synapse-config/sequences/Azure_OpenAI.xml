<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Azure_OpenAI" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <propertyGroup>
        <property expression="fn:concat(get-property('file','IDP_API_GATEWAY_ENDPOINT'),'/openai')" name="uri.var.apigateway" scope="default" type="STRING"/>
        <property name="ContentType" scope="axis2" type="STRING" value="application/json"/>
        <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Send request to OpenAI"/>
    </log>
    <header action="remove" name="Content-Encoding" scope="transport"/>
    <payloadFactory media-type="json">
        <format>{&#xd;
    "messages": [&#xd;
        {&#xd;
            "role": "user",&#xd;
            "content": "$1"&#xd;
        }&#xd;
    ],&#xd;
    "temperature": 0.7,&#xd;
    "top_p":0.95,&#xd;
    "max_tokens":2000&#xd;
}</format>
        <args>
            <arg evaluator="xml" expression="$ctx:prompt"/>
        </args>
    </payloadFactory>
    <call blocking="true">
        <endpoint>
            <http method="post" uri-template="{uri.var.apigateway}">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>-1</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>3</retriesBeforeSuspension>
                    <retryDelay>2000</retryDelay>
                </markForSuspension>
                <retryConfig>
                    <disabledErrorCodes>400</disabledErrorCodes>
                </retryConfig>
            </http>
        </endpoint>
    </call>
    <propertyGroup/>
    <log>
        <property name="Message" value="Request OpenAI completed"/>
    </log>
</sequence>
