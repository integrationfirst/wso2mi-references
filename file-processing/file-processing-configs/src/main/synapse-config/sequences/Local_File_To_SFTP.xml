<?xml version="1.0" encoding="UTF-8"?>
<sequence name="Local_File_To_SFTP" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="Message" value="Upload file to SFTP"/>
    </log>
    <propertyGroup>
        <property expression="$body/mediate/dir" name="scanningDir" scope="default" type="STRING"/>
        <property expression="$body/mediate/filePattern" name="filePattern" scope="default" type="STRING"/>
        <property expression="$body/mediate/archivedDir" name="archivedDir" scope="default" type="STRING"/>
    </propertyGroup>
    <log>
        <property name="Message" value="Reading files..."/>
        <property expression="$ctx:scanningDir" name="Scanning Dir"/>
        <property expression="$ctx:filePattern" name="File Pattern"/>
    </log>
    <file.listFiles configKey="LOCAL_FILE_DIR">
        <directoryPath>{$ctx:scanningDir}</directoryPath>
        <matchingPattern>{$ctx:filePattern}</matchingPattern>
        <recursive>false</recursive>
        <responseFormat>Hierarchical</responseFormat>
        <sortingAttribute>Name</sortingAttribute>
        <sortingOrder>Ascending</sortingOrder>
    </file.listFiles>
    <log level="full"/>
    <foreach expression="//listFilesResult/directory/file/text()">
        <sequence>
            <property expression="$body" name="filename" scope="default" type="STRING"/>
            <log>
                <property name="Message" value="Moving file..."/>
                <property expression="$ctx:filename" name="Filename"/>
                <property expression="get-property('FOREACH_COUNTER')" name="Offset"/>
            </log>
            <file.move configKey="LOCAL_FILE_DIR">
                <sourcePath>{fn:concat($ctx:scanningDir,'/',$ctx:filename)}</sourcePath>
                <targetPath>{$ctx:archivedDir}</targetPath>
                <createParentDirectories>true</createParentDirectories>
                <includeParent>false</includeParent>
                <overwrite>true</overwrite>
            </file.move>
            <log>
                <property name="Message" value="Archived completed"/>
                <property expression="$ctx:filename" name="Filename"/>
                <property expression="//moveFilesResult/success/text()" name="Archive Result"/>
            </log>
            <propertyGroup>
                <property name="UPLOAD_SUCCESSFUL" scope="default" type="STRING" value="true"/>
                <property expression="//moveFilesResult/success/text()" name="ARCHIVE_SUCCESSFUL" scope="default" type="STRING"/>
            </propertyGroup>
        </sequence>
    </foreach>
</sequence>
